<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Output.txt è½¬ JSON å·¥å…·</title>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f6f9; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; }
        textarea { width: 100%; height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 13px; resize: vertical; margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .btn-convert { background-color: #28a745; color: white; }
        .btn-convert:hover { background-color: #218838; }
        #status { margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px; color: #495057; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“‚ Output.txt è½¬ JSON ä¸“ç”¨å·¥å…·</h2>
        <p>è¯·æ‰“å¼€æ‚¨çš„ <code>output.txt</code> æ–‡ä»¶ï¼Œ<b>å…¨é€‰å¤åˆ¶</b>ï¼Œç„¶åç²˜è´´åˆ°ä¸‹æ–¹æ¡†ä¸­ï¼š</p>
        <textarea id="rawInput" placeholder="åœ¨æ­¤ç²˜è´´ output.txt çš„å…¨éƒ¨å†…å®¹..."></textarea>
        <div class="btn-group">
            <button class="btn-convert" onclick="processText()">ğŸš€ è½¬æ¢å¹¶ä¸‹è½½ JSON</button>
        </div>
        <div id="status"></div>
    </div>

    <script>
        function processText() {
            const input = document.getElementById('rawInput').value;
            const statusDiv = document.getElementById('status');
            
            if (!input.trim()) {
                alert("è¯·å…ˆç²˜è´´å†…å®¹ï¼");
                return;
            }

            try {
                let text = input;

                // å»æ‰ [source] æ ‡ç­¾
                text = text.replace(/\[source\]/g, "");

                // å»æ‰å•ç‹¬çš„é¡µç è¡Œ "- 123 -"
                text = text.replace(/^\s*-\s*\d+\s*-\s*$/gm, "");

                // å»æ‰å¤šä½™ç©ºè¡Œ
                text = text.replace(/\n\s*\n/g, "\n");

                // åˆ†å‰²é¢˜å—
                const splitRegex = /\n(?=\d+ã€)/g;
                const blocks = text.split(splitRegex);

                const questions = [];
                let successCount = 0;

                blocks.forEach(block => {
                    block = block.trim();
                    const idMatch = block.match(/^(\d+)ã€/);
                    if (!idMatch) return;

                    const id = parseInt(idMatch[1]);
                    
                    // æå–ç­”æ¡ˆ
                    const ansMatch = block.match(/ç­”æ¡ˆ[ï¼š:]\s*([A-D]+)/);
                    if (!ansMatch) return;

                    const answer = ansMatch[1].trim();

                    // é¢˜ç›®å†…å®¹
                    const ansIndex = ansMatch.index;
                    const idLength = idMatch[0].length;
                    let fullContent = block.substring(idLength, ansIndex).trim();

                    const options = {};
                    let questionText = fullContent;

                    // æ£€æŸ¥æ˜¯å¦æœ‰é€‰é¡¹
                    const firstOptMatch = fullContent.match(/(\s|^)A\./);
                    if (firstOptMatch) {
                        questionText = fullContent.substring(0, firstOptMatch.index).trim();
                        const optsContent = fullContent.substring(firstOptMatch.index);

                        const optRegex = /([A-D])\.\s*([\s\S]+?)(?=(\s[A-D]\.|$))/g;
                        let m;
                        const flatOpts = optsContent.replace(/\n/g, " ");
                        while ((m = optRegex.exec(flatOpts)) !== null) {
                            options[m[1]] = m[2].trim();
                        }
                    } else {
                        // åˆ¤æ–­é¢˜å¤„ç†
                        if (answer.length === 1 && (fullContent.includes("ï¼ˆ ï¼‰") || fullContent.includes("( )"))) {
                            options["A"] = "æ­£ç¡®";
                            options["B"] = "é”™è¯¯";
                        }
                    }

                    questionText = questionText.replace(/\n/g, "");
                    questions.push({ id, question: questionText, options, answer });
                    successCount++;
                });

                const jsonStr = JSON.stringify(questions, null, 4);
                const blob = new Blob([jsonStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "question_bank_full.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                statusDiv.style.display = 'block';
                statusDiv.innerText = `âœ… è½¬æ¢æˆåŠŸï¼\nå…±æå–é¢˜ç›®ï¼š${successCount} é“\næ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½ã€‚`;

            } catch (e) {
                console.error(e);
                alert("è½¬æ¢å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—");
            }
        }
    </script>
</body>
</html>
